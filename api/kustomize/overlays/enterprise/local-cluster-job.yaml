apiVersion: batch/v1
kind: Job
metadata:
  name: ship-cluster-local-cluster
spec:
  template:
    spec:
      imagePullSecrets:
        - name: replicatedregistrykey
      restartPolicy: OnFailure
      containers:
        - name: ship-cluster-local-cluster
          image: registry.replicated.com/ship-enterprise/kotsadm-api
          imagePullPolicy: IfNotPresent
          env:
            - name: SHIP_API_ADVERTISE_ENDPOINT
              value: 'https://{{repl ConfigOption "hostname"}}'
            - name: POSTGRES_URI
              valueFrom:
                secretKeyRef:
                  name: ship-enterprise-postgres
                  key: uri
            - name: ENSURE_LOCAL_CLUSTER
              value: '{{repl ConfigOption "ensure_local_cluster"}}'
          args: ["/src/shipcloudctl", "ensure-local-cluster"]
