
# the fact that is is a Job and not a Pod is kinda janky in skaffold but it looks like they're
# aware of the job issue and have a fix in code review right now
#
#     https://github.com/GoogleContainerTools/skaffold/issues/891
#
# The workaround in the mean time is to restart the `skaffold dev` watcher to get
# new migrations deployed
apiVersion: batch/v1
kind: Job
metadata:
  name: ship-cluster-migrations
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: migrations
        image: ship-cluster-migrations
        imagePullPolicy: IfNotPresent
        env:
        - name: POSTGRES_URI
          valueFrom:
            secretKeyRef:
              name: ship-postgres
              key: uri
